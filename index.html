<!DOCTYPE html>
<html lang="en" class="h-full overflow-hidden">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ALI Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Orbitron:wght@400;600&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neonCyan: '#0ff6ff',
                        neonMagenta: '#ff3ac3',
                    },
                    animation: {
                        'glow-pulse': 'glowPulse 2s infinite',
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'minimize': 'minimize 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'maximize': 'maximize 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulseGlow 3s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        glowPulse: {
                            '0%, 100%': { boxShadow: '0 0 8px rgba(0,246,255,0.6)' },
                            '50%': { boxShadow: '0 0 20px rgba(0,246,255,0.9)' },
                        },
                        fadeIn: { '0%': { opacity: 0, transform: 'scale(0.95)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
                        minimize: { '0%': { transform: 'scale(1)', opacity: 1 }, '100%': { transform: 'scale(0.95)', opacity: 0 } },
                        maximize: { '0%': { transform: 'scale(0.95)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
                        pulseGlow: { '0%': { opacity: 0.1 }, '100%': { opacity: 0.3 } }
                    }
                }
            },
            plugins: [
                function ({ addUtilities }) {
                    addUtilities({
                        '.glass': {
                            'background': 'rgba(255, 255, 255, 0.08)',
                            'backdrop-filter': 'blur(8px)',
                            'border': '1px solid rgba(255, 255, 255, 0.12)',
                            'box-shadow': '0 4px 20px rgba(0, 0, 0, 0.2)',
                        },
                        '.neon-border': {
                            'box-shadow': '0 0 12px rgba(0,246,255,0.4)',
                        },
                        '.neon-text': {
                            'color': '#0ff6ff',
                            'text-shadow': '0 0 10px rgba(0,246,255,0.7)',
                        },
                        '::-webkit-scrollbar': { 'display': 'none' },
                        '::-webkit-scrollbar-thumb': { 'display': 'none' }
                    })
                }
            ]
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            position: relative;
        }

        /* Animated Background */
        #animated-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(15, 246, 255, 0.6);
            border-radius: 50%;
            animation: float 6s infinite, pulseGlow 3s infinite alternate;
        }

        .window {
            display: flex;
            flex-direction: column;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 0;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .app-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            margin: 8px;
            cursor: pointer;
        }

        .desktop-icon svg {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }

        .desktop-icon span {
            text-align: center;
            font-size: 0.75rem;
            color: white;
            text-shadow: 0 0 6px rgba(0, 246, 255, 0.7);
        }

        #system-clock {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 0 20px rgba(0, 246, 255, 0.9);
            z-index: 10;
        }

        #dock {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
            padding: 12px;
            border-radius: 24px;
            z-index: 30;
        }

        #desktop-icons {
            position: absolute;
            left: 24px;
            top: 24px;
            display: flex;
            flex-direction: column;
            z-index: 20;
        }

        #status-bar {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            cursor: nwse-resize;
            z-index: 10;
        }
    </style>
</head>

<body class="relative h-full text-gray-200">
    <!-- Animated Neon Background -->
    <div id="animated-bg"></div>

    <!-- Big Clock -->
    <div id="system-clock"></div>

    <!-- Status Bar -->
    <div id="status-bar">
        <div class="status-item neon-text">
            <img src="assets/battery.png" alt="Battery Icon" width="24" height="24">
            <span id="battery">--%</span>
        </div>
        <div class="status-item neon-text">
            <img src="assets/clear-sky.png" alt="Battery Icon" width="24" height="24">
            <span id="weather">--°C</span>
        </div>
    </div>

    <!-- Desktop Icons -->
    <div id="desktop-icons"></div>

    <!-- Windows -->
    <div id="windows-container" class="absolute inset-0 z-20 pointer-events-none"></div>

    <!-- Dock -->
    <div id="dock" class="absolute glass backdrop-blur-md flex space-x-4"></div>

    <!-- Notifications -->
    <div id="notifications" class="fixed top-20 right-4 z-40 space-y-2"></div>

    <script>
        // === ANIMATED BACKGROUND ===
        function createParticles() {
            const bg = document.getElementById('animated-bg');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 6}s`;
                particle.style.width = `${2 + Math.random() * 4}px`;
                particle.style.height = particle.style.width;
                bg.appendChild(particle);
            }
        }

        // === GLOBAL STATE ===
        const state = {
            windows: [],
            nextZIndex: 100,
            focusedWindowId: null,
            apps: {},
            settings: { animations: true },
            terminalHistory: [],
            terminalHistoryIndex: -1,
            fileSystem: {
                music: [],
                images: []
            }
        };

        // === ICONS ===
        const icons = {
            terminal: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 17l6-6-6-6M12 19h8"/></svg>`,
            calculator: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h8M8 16h4"/></svg>`,
            music: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="8"/><path d="M12 4v8l3-3"/></svg>`,
            gallery: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`,
            files: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`,
            settings: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
            notes: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>`,
            youtube: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="red"><path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.81-.25.88-.61 1.49-1.08 1.81.47.32.83.93 1.08 1.81.28 1.01.44 2.62.44 4.81v.41c-.5.16-4.8.5-9.56.5-4.76 0-9.06-.34-9.56-.5v-.41c0-2.19.16-3.8.44-4.81.25-.88.61-1.49 1.08-1.81-.47-.32-.83-.93-1.08-1.81C1.16 15.8 1 14.19 1 12s.16-3.8.44-4.81c.25-.88.61-1.49 1.08-1.81C2.06 5.7 1.7 6.31 1.44 7.19 1.16 8.2 1 9.81 1 12s.16 3.8.44 4.81c.25.88.61 1.49 1.08 1.81.47.32.83.93 1.08 1.81.28 1.01.44 2.62.44 4.81v.41c-.5.16-4.8.5-9.56.5-4.76 0-9.06-.34-9.56-.5v-.41c0-2.19.16-3.8.44-4.81.25-.88.61-1.49 1.08-1.81-.47-.32-.83-.93-1.08-1.81C1.16 15.8 1 14.19 1 12s.16-3.8.44-4.81c.25-.88.61-1.49 1.08-1.81C2.06 5.7 1.7 6.31 1.44 7.19 1.16 8.2 1 9.81 1 12z"/></svg>`,
            tetris: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>`
        };

        // === FILE SYSTEM UTILS ===
        async function loadFilesFromDirectory(dirHandle, path = '') {
            const files = [];
            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        files.push({
                            name: entry.name,
                            path: path + entry.name,
                            handle: entry
                        });
                    } else if (entry.kind === 'directory') {
                        const subFiles = await loadFilesFromDirectory(entry, path + entry.name + '/');
                        files.push(...subFiles);
                    }
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
            return files;
        }

        async function scanForMediaFiles() {
            try {
                // Music fayllarni skanerlash
                const musicDirHandle = await window.showDirectoryPicker();
                const allFiles = await loadFilesFromDirectory(musicDirHandle);

                // Music fayllarni ajratib olish
                state.fileSystem.music = allFiles.filter(file =>
                    file.name.match(/\.(mp3|wav|m4a|ogg|flac)$/i)
                );

                // Image fayllarni ajratib olish
                state.fileSystem.images = allFiles.filter(file =>
                    file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)
                );

                notify(`Loaded ${state.fileSystem.music.length} music files and ${state.fileSystem.images.length} images`);
                return true;
            } catch (error) {
                console.error('Error scanning media files:', error);
                notify('Could not access directory');
                return false;
            }
        }

        async function getFileUrl(fileHandle) {
            const file = await fileHandle.getFile();
            return URL.createObjectURL(file);
        }

        // === APP REGISTRY ===
        const AppRegistry = {
            register(app) { state.apps[app.id] = app; },
            open(id, data = {}) {
                if (state.windows.some(w => w.id === id)) {
                    this.focus(id); return;
                }
                const zIndex = ++state.nextZIndex;
                const winId = `win-${id}-${Date.now()}`;
                const windowEl = document.createElement('div');
                windowEl.id = winId;
                windowEl.className = `window absolute glass rounded-xl overflow-hidden pointer-events-auto ${state.settings.animations ? 'animate-fade-in' : ''}`;
                windowEl.style.zIndex = zIndex;
                windowEl.style.width = '520px';
                windowEl.style.height = '420px';
                windowEl.style.left = `${Math.random() * 30 + 10}%`;
                windowEl.style.top = `${Math.random() * 30 + 10}%`;

                const app = state.apps[id];
                const titlebar = document.createElement('div');
                titlebar.className = 'titlebar flex items-center justify-between p-3 bg-black/20 neon-border';
                titlebar.innerHTML = `
          <div class="flex items-center space-x-2">
            ${app.icon}
            <span class="font-semibold">${app.name}</span>
          </div>
          <div class="titlebar-buttons flex space-x-2">
            <button class="w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-300 hover:bg-yellow-500/40 min-btn" aria-label="Minimize">−</button>
            <button class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center text-green-300 hover:bg-green-500/40 max-btn" aria-label="Maximize">□</button>
            <button class="w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center text-red-300 hover:bg-red-500/40 close-btn" aria-label="Close">×</button>
          </div>
        `;
                windowEl.appendChild(titlebar);

                const content = document.createElement('div');
                content.className = 'flex-1 overflow-hidden p-4';
                windowEl.appendChild(content);

                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                windowEl.appendChild(resizeHandle);

                document.getElementById('windows-container').appendChild(windowEl);
                // AppRegistry.open() ichida
                app.render(content, { winId });

                this.focus(winId);
                this.makeDraggable(windowEl, titlebar);
                // Resize faqat Tetris emas bo'lsa ishlasin
                if (id !== 'tetris') {
                    this.makeResizable(windowEl, resizeHandle);
                }
                // AppRegistry.open() ichida
                if (id === 'tetris') {
                    windowEl.style.width = '330px';   // 300 (canvas) + 20 (padding)
                    windowEl.style.height = '680px';  // 600 (canvas) + 30 (titlebar) + 30 (padding)
                } else {
                    windowEl.style.width = '520px';
                    windowEl.style.height = '420px';
                }
                windowEl.querySelector('.close-btn').addEventListener('click', () => this.close(winId));
                windowEl.querySelector('.min-btn').addEventListener('click', () => this.minimize(winId));
                windowEl.querySelector('.max-btn').addEventListener('click', () => this.toggleMaximize(winId));

                state.windows.push({ id: winId, appId: id, el: windowEl, maximized: false });
                this.saveState();
            },
            close(winId) {
                const win = state.windows.find(w => w.id === winId);
                if (win) {
                    win.el.remove();
                    state.windows = state.windows.filter(w => w.id !== winId);
                    if (state.focusedWindowId === winId) {
                        const last = state.windows[state.windows.length - 1];
                        if (last) this.focus(last.id); else state.focusedWindowId = null;
                    }
                    this.saveState();
                }
            },
            minimize(winId) {
                const win = state.windows.find(w => w.id === winId);
                if (win) {
                    win.minimized = true;
                    if (state.settings.animations) {
                        win.el.classList.add('animate-minimize');
                        setTimeout(() => {
                            win.el.style.visibility = 'hidden';
                            win.el.style.zIndex = '1'; // fonga tushdi
                        }, 200);
                    } else {
                        win.el.style.visibility = 'hidden';
                        win.el.style.zIndex = '1';
                    }
                    // Dockda belgilash
                    this.updateDockIndicator(winId, true);
                }
            },
            toggleMaximize(winId) {
                const win = state.windows.find(w => w.id === winId);
                if (win) {
                    if (win.maximized) {
                        Object.assign(win.el.style, win.restore);
                        win.maximized = false;
                    } else {
                        win.restore = {
                            width: win.el.style.width,
                            height: win.el.style.height,
                            left: win.el.style.left,
                            top: win.el.style.top
                        };
                        win.el.style.width = '100%';
                        win.el.style.height = '100%';
                        win.el.style.left = '0';
                        win.el.style.top = '0';
                        win.maximized = true;
                        if (state.settings.animations) win.el.classList.add('animate-maximize');
                    }
                }
            },
            focus(winId) {
                const win = state.windows.find(w => w.id === winId);
                if (win) {
                    win.el.style.visibility = 'visible';
                    win.el.style.zIndex = ++state.nextZIndex;
                    win.el.classList.add('neon-border');
                    win.minimized = false;
                    state.focusedWindowId = winId;
                    document.querySelectorAll('.window').forEach(w => {
                        if (w.id !== winId) w.classList.remove('neon-border');
                    });
                    // Dockdan belgini olib tashlash
                    this.updateDockIndicator(winId, false);
                }
            },
            updateDockIndicator(winId, minimized) {
                const win = state.windows.find(w => w.id === winId);
                if (!win) return;
                const appId = win.appId;
                const dockIcons = document.querySelectorAll(`#dock .app-icon[data-app-id="${appId}"]`);
                dockIcons.forEach(icon => {
                    if (minimized) {
                        icon.classList.add('minimized-indicator');
                    } else {
                        icon.classList.remove('minimized-indicator');
                    }
                });
            },
            makeDraggable(el, handle) {
                let isDragging = false, startX, startY, initialX, initialY;

                handle.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.titlebar-buttons')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = el.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    // Screen bounds
                    const maxX = window.innerWidth - el.offsetWidth;
                    const maxY = window.innerHeight - el.offsetHeight;
                    let newX = Math.max(0, Math.min(initialX + dx, maxX));
                    let newY = Math.max(0, Math.min(initialY + dy, maxY));

                    el.style.left = `${newX}px`;
                    el.style.top = `${newY}px`;
                });

                document.addEventListener('mouseup', () => isDragging = false);
            },
            makeResizable(el, handle) {
                let isResizing = false, startX, startY, startWidth, startHeight;

                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseInt(document.defaultView.getComputedStyle(el).width, 10);
                    startHeight = parseInt(document.defaultView.getComputedStyle(el).height, 10);
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    const newWidth = Math.max(320, startWidth + dx);
                    const newHeight = Math.max(240, startHeight + dy);
                    const maxX = window.innerWidth;
                    const maxY = window.innerHeight;
                    el.style.width = `${Math.min(newWidth, maxX)}px`;
                    el.style.height = `${Math.min(newHeight, maxY)}px`;
                });

                document.addEventListener('mouseup', () => isResizing = false);
            },
            saveState() {
                const layout = state.windows.map(w => ({
                    appId: w.appId,
                    left: w.el.style.left,
                    top: w.el.style.top,
                    width: w.el.style.width,
                    height: w.el.style.height,
                    maximized: w.maximized
                }));
                localStorage.setItem('hyperOSState', JSON.stringify({ layout, settings: state.settings }));
            },
            loadState() {
                const saved = localStorage.getItem('hyperOSState');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.settings = { ...state.settings, ...data.settings };
                    data.layout.forEach(win => {
                        const id = win.appId;
                        if (state.apps[id]) {
                            AppRegistry.open(id);
                            setTimeout(() => {
                                const lastWin = state.windows[state.windows.length - 1];
                                if (lastWin) {
                                    if (win.maximized) {
                                        AppRegistry.toggleMaximize(lastWin.id);
                                    } else {
                                        Object.assign(lastWin.el.style, {
                                            left: win.left,
                                            top: win.top,
                                            width: win.width,
                                            height: win.height
                                        });
                                    }
                                }
                            }, 100);
                        }
                    });
                }
            }
        };

        // === UTILS ===
        function notify(message) {
            const notif = document.createElement('div');
            notif.className = 'glass rounded-lg p-3 text-sm max-w-xs animate-fade-in';
            notif.textContent = message;
            document.getElementById('notifications').appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // === BATTERY & WEATHER ===
        async function updateBattery() {
            try {
                const battery = await navigator.getBattery();
                document.getElementById('battery').textContent = `${Math.round(battery.level * 100)}%`;
            } catch (e) {
                document.getElementById('battery').textContent = '87%';
            }
        }

        async function updateWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.77&longitude=-122.42&current=temperature_2m');
                const data = await res.json();
                document.getElementById('weather').textContent = `${Math.round(data.current.temperature_2m)}°C`;
            } catch (e) {
                document.getElementById('weather').textContent = '22°C';
            }
        }

        // === TETRIS GAME ===
        function initTetris(container) {
            // Start screen
            const startScreen = document.createElement('div');
            startScreen.innerHTML = `
        <div style="position: absolute; top: 0; left: 0; width: 300px; height: 600px; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-family: Arial; z-index: 10;">
            <h2>Tetris</h2>
            <button id="startBtn" style="padding: 10px 20px; font-size: 16px; margin: 10px;">Start</button>
            <div>Use ← → ↓ ↑ and Space</div>
        </div>
    `;
            container.appendChild(startScreen);

            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 600;
            container.appendChild(canvas);
            const ctx = canvas.getContext('2d');

            const COLS = 10, ROWS = 20;
            const BLOCK_SIZE = 30;
            let board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
            let score = 0;
            let highScore = localStorage.getItem('tetrisHighScore') ? parseInt(localStorage.getItem('tetrisHighScore')) : 0;
            let gameRunning = false;
            let gameLoop = null;
            let nextPieceShape = null;

            const SHAPES = [
                [[1, 1, 1, 1]], // I
                [[1, 1, 1], [0, 1, 0]], // T
                [[1, 1, 1], [1, 0, 0]], // L
                [[1, 1, 1], [0, 0, 1]], // J
                [[1, 1], [1, 1]], // O
                [[0, 1, 1], [1, 1, 0]], // S
                [[1, 1, 0], [0, 1, 1]] // Z
            ];

            function getRandomPiece() {
                return SHAPES[Math.floor(Math.random() * SHAPES.length)];
            }

            let piece = {
                shape: null,
                x: 0,
                y: 0
            };

            // Initialize first piece and next
            nextPieceShape = getRandomPiece();
            function spawnNewPiece() {
                piece.shape = nextPieceShape;
                piece.x = Math.floor(COLS / 2) - Math.floor(piece.shape[0].length / 2);
                piece.y = 0;
                nextPieceShape = getRandomPiece();

                if (!isValidMove(piece.shape, piece.x, piece.y)) {
                    gameOver();
                }
            }

            function drawBoard() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Draw board cells
                for (let y = 0; y < ROWS; y++) {
                    for (let x = 0; x < COLS; x++) {
                        if (board[y][x]) {
                            ctx.fillStyle = '#0ff6ff';
                            ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            ctx.strokeStyle = '#000';
                            ctx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                        }
                    }
                }

                // Draw outer border around the playfield
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, COLS * BLOCK_SIZE, ROWS * BLOCK_SIZE);
                ctx.lineWidth = 1; // reset to default
            }

            function drawPiece() {
                if (!piece.shape) return;
                ctx.fillStyle = '#ff3ac3';
                for (let y = 0; y < piece.shape.length; y++) {
                    for (let x = 0; x < piece.shape[y].length; x++) {
                        if (piece.shape[y][x]) {
                            ctx.fillRect((piece.x + x) * BLOCK_SIZE, (piece.y + y) * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            ctx.strokeStyle = '#000';
                            ctx.strokeRect((piece.x + x) * BLOCK_SIZE, (piece.y + y) * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                        }
                    }
                }
            }

            function drawNextPiece() {
                const offsetX = COLS * BLOCK_SIZE + 20;
                const offsetY = 50;
                ctx.fillStyle = '#aaa';
                ctx.font = '16px Arial';
                ctx.fillText('Next:', offsetX, offsetY - 10);
                ctx.fillStyle = '#ff3ac3';
                for (let y = 0; y < nextPieceShape.length; y++) {
                    for (let x = 0; x < nextPieceShape[y].length; x++) {
                        if (nextPieceShape[y][x]) {
                            ctx.fillRect(offsetX + x * BLOCK_SIZE, offsetY + y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            ctx.strokeStyle = '#000';
                            ctx.strokeRect(offsetX + x * BLOCK_SIZE, offsetY + y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                        }
                    }
                }
            }

            function drawScore() {
                ctx.fillStyle = '#fff';
                ctx.font = '18px Arial';
                ctx.fillText(`Score: ${score}`, 10, 30);
                ctx.fillText(`High: ${highScore}`, 10, 60);
            }

            function isValidMove(shape, x, y) {
                for (let row = 0; row < shape.length; row++) {
                    for (let col = 0; col < shape[row].length; col++) {
                        if (shape[row][col]) {
                            const newX = x + col;
                            const newY = y + row;
                            if (newX < 0 || newX >= COLS || newY >= ROWS) return false;
                            if (newY >= 0 && board[newY][newX]) return false;
                        }
                    }
                }
                return true;
            }

            function placePiece() {
                for (let y = 0; y < piece.shape.length; y++) {
                    for (let x = 0; x < piece.shape[y].length; x++) {
                        if (piece.shape[y][x]) {
                            const boardY = piece.y + y;
                            const boardX = piece.x + x;
                            if (boardY >= 0) board[boardY][boardX] = 1;
                        }
                    }
                }

                // Clear lines
                let linesCleared = 0;
                for (let y = ROWS - 1; y >= 0; y--) {
                    if (board[y].every(cell => cell)) {
                        board.splice(y, 1);
                        board.unshift(Array(COLS).fill(0));
                        linesCleared++;
                        y++; // recheck same row
                    }
                }

                if (linesCleared > 0) {
                    score += linesCleared * 10;
                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('tetrisHighScore', highScore);
                    }
                }

                spawnNewPiece();
            }

            function movePiece(dx, dy) {
                if (!gameRunning) return;
                if (isValidMove(piece.shape, piece.x + dx, piece.y + dy)) {
                    piece.x += dx;
                    piece.y += dy;
                } else if (dy > 0) {
                    placePiece();
                }
                render();
            }

            function rotatePiece() {
                if (!gameRunning) return;
                const rotated = piece.shape[0].map((_, i) =>
                    piece.shape.map(row => row[i]).reverse()
                );
                if (isValidMove(rotated, piece.x, piece.y)) {
                    piece.shape = rotated;
                }
                render();
            }

            function hardDrop() {
                if (!gameRunning) return;
                while (isValidMove(piece.shape, piece.x, piece.y + 1)) {
                    piece.y++;
                }
                placePiece();
                render();
            }

            function render() {
                drawBoard();
                drawPiece();
                drawNextPiece();
                drawScore();
            }

            function gameStep() {
                movePiece(0, 1);
            }

            function startGame() {
                board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
                score = 0;
                nextPieceShape = getRandomPiece();
                spawnNewPiece();
                gameRunning = true;
                startScreen.style.display = 'none';
                render();
                gameLoop = setInterval(gameStep, 500);
            }

            function pauseGame() {
                if (!gameRunning) return;
                gameRunning = false;
                clearInterval(gameLoop);
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSED', canvas.width / 2, canvas.height / 2);
                ctx.textAlign = 'left';
            }

            function resumeGame() {
                if (gameRunning) return;
                gameRunning = true;
                gameLoop = setInterval(gameStep, 500);
                render();
            }

            function gameOver() {
                gameRunning = false;
                clearInterval(gameLoop);
                notify('Game Over! Score: ' + score);
                startScreen.style.display = 'flex';
                startScreen.querySelector('h2').textContent = 'Game Over';
                startScreen.querySelector('#startBtn').textContent = 'Restart';
            }

            // Event listeners
            startScreen.querySelector('#startBtn').addEventListener('click', () => {
                startGame();
            });

            document.addEventListener('keydown', (e) => {
                if (!gameRunning) {
                    if (e.key === ' ') {
                        startGame();
                    }
                    return;
                }

                switch (e.key) {
                    case 'ArrowLeft': movePiece(-1, 0); break;
                    case 'ArrowRight': movePiece(1, 0); break;
                    case 'ArrowDown': movePiece(0, 1); break;
                    case 'ArrowUp': rotatePiece(); break;
                    case ' ': hardDrop(); break;
                    case 'p':
                    case 'P':
                        if (gameRunning) {
                            pauseGame();
                        } else {
                            resumeGame();
                        }
                        break;
                }
            });
        }

        // === APPS ===
        AppRegistry.register({
            id: 'terminal',
            name: 'Terminal',
            icon: icons.terminal,
            render(el) {
                el.innerHTML = `
          <div class="font-mono text-green-300 text-sm h-full flex flex-col bg-black/20 rounded-lg p-3">
            <div id="terminal-output" class="flex-1 overflow-y-auto mb-2 whitespace-pre-wrap"></div>
            <div class="flex">
              <span class="text-cyan-300 mr-2">$</span>
              <input id="terminal-input" class="bg-transparent outline-none flex-1" type="text" autocomplete="off" />
            </div>
          </div>
        `;
                const output = el.querySelector('#terminal-output');
                const input = el.querySelector('#terminal-input');

                const commands = {
                    help: () => 'Available: help, calc [expr], open [app], play demo, clear, echo [text], date, ls, scan, info, hack',
                    calc: (args) => {
                        try {
                            const expr = args.join(' ').replace(/[^-()\d/*+. ]/g, '');
                            return eval(expr).toString();
                        } catch { return 'Invalid expression'; }
                    },
                    open: (args) => {
                        const appId = args[0];
                        if (state.apps[appId]) {
                            AppRegistry.open(appId);
                            return `Opening ${appId}...`;
                        }
                        return `App not found: ${appId}`;
                    },
                    play: () => {
                        AppRegistry.open('music');
                        return 'Playing demo track...';
                    },
                    clear: () => { output.innerHTML = ''; return ''; },
                    echo: (args) => args.join(' '),
                    date: () => new Date().toString(),
                    ls: () => Object.keys(state.apps).join(', '),
                    scan: async () => {
                        const success = await scanForMediaFiles();
                        return success ? 'Media files scanned successfully' : 'Failed to scan media files';
                    },
                    // Yangi: info
                    info: () => {
                        return `ALI Project v1.0 (Project ALI)
Kernel: ALI OS
Architecture: WebAssembly / HTML5
Author: ALI Team
Telegram: @Syntax_Ali
Build Date: ${new Date('2025-10-09').toDateString()}
Uptime: ${Math.floor(performance.now() / 1000 / 60)} min`;
                    },
                    // commands obyektiga qo'shing (eski "hack"ni almashtiring)
                    hack: () => {
                        print('>>> Launching intrusion protocol...', 'text-red-500');
                        print('[*] Target: global_network.core', 'text-yellow-400');

                        let logCount = 0;
                        const totalLogs = 35;
                        const logTypes = [
                            () => `[+] Scanning subnet 192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}/24`,
                            () => `[-] Port ${Math.floor(Math.random() * 65535)}: closed`,
                            () => `[+] Port ${[22, 80, 443, 3389, 3306][Math.floor(Math.random() * 5)]}: open (service: ${['SSH', 'HTTP', 'HTTPS', 'RDP', 'MySQL'][Math.floor(Math.random() * 5)]})`,
                            () => `[i] Bypassing firewall rule #${Math.floor(Math.random() * 1000)}`,
                            () => `[!] Intrusion detection triggered — spoofing MAC...`,
                            () => `[+] Extracting credentials from memory dump...`,
                            () => `[+] Decrypted packet: ${btoa(Math.random().toString(36).substring(2, 10))}`,
                            () => `[i] Routing through proxy: ${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}:${Math.floor(1000 + Math.random() * 9000)}`,
                            () => `[+] Session hijacked: user=admin, token=***`,
                            () => `[i] Uploading payload: reverse_shell.exe (12.4 KB)`,
                            () => `[+] Establishing encrypted tunnel...`,
                            () => `[!] Antivirus evaded via polymorphic code`,
                            () => `[+] Database dump: users_table (12,483 records)`,
                            () => `[i] Geolocation: Latitude ${(-90 + Math.random() * 180).toFixed(4)}, Longitude ${(-180 + Math.random() * 360).toFixed(4)}`
                        ];

                        const logInterval = setInterval(() => {
                            if (logCount >= totalLogs) {
                                clearInterval(logInterval);
                                // Globus chizish
                                const globeArt = `
      ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣄⣠⣀⡀⣀⣠⣤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣄⢠⣠⣼⣿⣿⣿⣟⣿⣿⣿⣿⣿⣿⣿⣿⡿⠋⠀⠀⠀⢠⣤⣦⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠰⢦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⣟⣾⣿⣽⣿⣿⣅⠈⠉⠻⣿⣿⣿⣿⣿⡿⠇⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⠀⢀⡶⠒⢉⡀⢠⣤⣶⣶⣿⣷⣆⣀⡀⠀⢲⣖⠒⠀⠀⠀⠀⠀⠀⠀
⢀⣤⣾⣶⣦⣤⣤⣶⣿⣿⣿⣿⣿⣿⣽⡿⠻⣷⣀⠀⢻⣿⣿⣿⡿⠟⠀⠀⠀⠀⠀⠀⣤⣶⣶⣤⣀⣀⣬⣷⣦⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣦⣤⣦⣼⣀⠀
⠈⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠓⣿⣿⠟⠁⠘⣿⡟⠁⠀⠘⠛⠁⠀⠀⢠⣾⣿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠏⠙⠁
⠀⠸⠟⠋⠀⠈⠙⣿⣿⣿⣿⣿⣿⣷⣦⡄⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⣼⣆⢘⣿⣯⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡉⠉⢱⡿⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣟⡿⠦⠀⠀⠀⠀⠀⠀⠀⠙⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⡗⠀⠈⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢻⣿⣿⣿⣿⣿⣿⣿⣿⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⣉⣿⡿⢿⢷⣾⣾⣿⣞⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠋⣠⠟⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣿⣿⣿⠿⠿⣿⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣾⣿⣿⣷⣦⣶⣦⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠈⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠻⣿⣤⡖⠛⠶⠤⡀⠀⠀⠀⠀⠀⠀⠀⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠁⠙⣿⣿⠿⢻⣿⣿⡿⠋⢩⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⠧⣤⣦⣤⣄⡀⠀⠀⠀⠀⠀⠘⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠘⣧⠀⠈⣹⡻⠇⢀⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣤⣀⡀⠀⠀⠀⠀⠀⠀⠈⢽⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠹⣷⣴⣿⣷⢲⣦⣤⡀⢀⡀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⣿⣿⣿⣿⣿⣿⠟⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣷⢀⡄⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠂⠛⣆⣤⡜⣟⠋⠙⠂⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣿⣿⣿⣿⠟⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⠉⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣤⣾⣿⣿⣿⣿⣆⠀⠰⠄⠀⠉⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⣿⡿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣿⡿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⣿⠿⠿⣿⣿⣿⠇⠀⠀⢀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣿⡿⠛⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢻⡇⠀⠀⢀⣼⠗⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⠃⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠁⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠒⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
`.trim();

                                const lines = globeArt.split('\n').filter(l => l.trim() !== '');
                                let i = 0;
                                const drawGlobe = () => {
                                    if (i < lines.length) {
                                        print(lines[i], 'text-green-400 font-mono');
                                        i++;
                                        setTimeout(drawGlobe, 70);
                                    } else {
                                        // Globusdan keyin qo'shimcha loglar
                                        setTimeout(() => {
                                            print('[+] Finalizing data extraction...', 'text-yellow-400');
                                            print('[+] Verifying root access...', 'text-yellow-400');

                                            // Yuklanish animatsiyalari (3 marta)
                                            let loadStep = 0;
                                            const loadingSteps = [
                                                'Authenticating session...',
                                                'Decrypting master key...',
                                                'Syncing with command server...'
                                            ];

                                            const animateLoading = () => {
                                                if (loadStep >= loadingSteps.length) {
                                                    // Tasdiqlash so'rovlari (3 marta)
                                                    let confirmCount = 0;
                                                    const askConfirm = () => {
                                                        if (confirmCount < 3) {
                                                            print(`\n>>> ${['Override security?', 'Confirm global access?', 'Execute payload?'][confirmCount]} [y/n]`, 'text-cyan-300');
                                                            // Simulyatsiya: avtomatik "y" javobi
                                                            setTimeout(() => {
                                                                print('y', 'text-green-300');
                                                                confirmCount++;
                                                                setTimeout(askConfirm, 800);
                                                            }, 1200);
                                                        } else {
                                                            print('\n>>> ALL CHECKS PASSED. SYSTEM FULLY COMPROMISED.', 'text-red-400 font-bold');
                                                            print('>>> Connection secured. Data exfiltration complete.', 'text-cyan-300');
                                                        }
                                                    };
                                                    askConfirm();
                                                    return;
                                                }

                                                const msg = loadingSteps[loadStep];
                                                let progress = 0;
                                                const interval = setInterval(() => {
                                                    const bar = '█'.repeat(progress) + '░'.repeat(20 - progress);
                                                    const pct = Math.min(100, Math.floor((progress / 20) * 100));
                                                    print(`\r${msg} [${bar}] ${pct}%`, 'text-green-400 font-mono');
                                                    progress++;
                                                    if (progress > 20) {
                                                        clearInterval(interval);
                                                        print(`\r${msg} [${'█'.repeat(20)}] 100% ✔`, 'text-green-300 font-mono');
                                                        loadStep++;
                                                        setTimeout(animateLoading, 600);
                                                    }
                                                }, 100);
                                            };
                                            animateLoading();
                                        }, 1000);
                                    }
                                };
                                drawGlobe();
                                return;
                            }

                            const log = logTypes[Math.floor(Math.random() * logTypes.length)]();
                            print(log, 'text-green-400 font-mono');
                            logCount++;
                        }, 300);

                        return '';
                    }
                }

                const print = (text, cls = '') => {
                    const line = document.createElement('div');
                    line.className = cls;
                    line.textContent = text;
                    output.appendChild(line);
                    output.scrollTop = output.scrollHeight;
                };

                print('ALI Project Terminal v1.0 — Type "help" for commands.', 'text-cyan-300');

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cmd = input.value.trim();
                        if (!cmd) return;
                        state.terminalHistory.push(cmd);
                        state.terminalHistoryIndex = state.terminalHistory.length;
                        print(`$ ${cmd}`);
                        input.value = '';

                        const [name, ...args] = cmd.split(' ');
                        if (commands[name]) {
                            const res = commands[name](args);
                            if (res) print(res);
                        } else {
                            print(`Command not found: ${name}`);
                        }
                    } else if (e.key === 'ArrowUp') {
                        if (state.terminalHistory.length > 0) {
                            if (state.terminalHistoryIndex > 0) state.terminalHistoryIndex--;
                            input.value = state.terminalHistory[state.terminalHistoryIndex] || '';
                        }
                    } else if (e.key === 'ArrowDown') {
                        if (state.terminalHistoryIndex < state.terminalHistory.length - 1) {
                            state.terminalHistoryIndex++;
                            input.value = state.terminalHistory[state.terminalHistoryIndex];
                        } else {
                            state.terminalHistoryIndex = state.terminalHistory.length;
                            input.value = '';
                        }
                    }
                });
            }
        });

        AppRegistry.register({
            id: 'calculator',
            name: 'Calculator',
            icon: icons.calculator,
            render(el) {
                el.innerHTML = `
          <div class="flex flex-col h-full">
            <div id="calc-display" class="text-right text-2xl p-3 bg-black/20 rounded-lg mb-4 h-16 flex items-center justify-end">0</div>
            <div class="grid grid-cols-4 gap-2 flex-1">
              <button class="col-span-3 p-3 glass rounded">0</button>
              <button class="p-3 glass rounded calc-btn">=</button>
              ${['1', '2', '3', '+', '4', '5', '6', '-', '7', '8', '9', '*', 'C', '.', '0', '/'].map(btn =>
                    `<button class="p-3 glass rounded calc-btn">${btn}</button>`
                ).join('')}
            </div>
          </div>
        `;
                const display = el.querySelector('#calc-display');
                let current = '0';
                let operator = null;
                let previous = null;
                let resetOnNext = false;

                el.querySelectorAll('.calc-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const val = btn.textContent;
                        if (['+', '-', '*', '/'].includes(val)) {
                            if (previous === null) previous = parseFloat(current);
                            else if (operator) {
                                const result = eval(`${previous} ${operator} ${current}`);
                                previous = result;
                                display.textContent = result;
                            }
                            operator = val;
                            resetOnNext = true;
                        } else if (val === 'C') {
                            current = '0';
                            previous = null;
                            operator = null;
                            resetOnNext = false;
                            display.textContent = '0';
                        } else if (val === '=') {
                            if (operator && previous !== null) {
                                const result = eval(`${previous} ${operator} ${current}`);
                                display.textContent = result;
                                current = result.toString();
                                previous = null;
                                operator = null;
                                resetOnNext = true;
                            }
                        } else {
                            if (resetOnNext) {
                                current = val;
                                resetOnNext = false;
                            } else {
                                current = current === '0' && val !== '.' ? val : current + val;
                            }
                            display.textContent = current;
                        }
                    });
                });
            }
        });

        AppRegistry.register({
            id: 'music',
            name: 'Music Player',
            icon: icons.music,
            async render(el, data) {
                let currentTrackIndex = 0;
                let audio = null;
                let isPlaying = false;
                let winId = data?.winId; // Oynaning ID sini saqlash

                // Demo online qo'shiqlar (ixtiyoriy)
                const demoTracks = [
                    { name: 'ATLXS - PASSO BEM SOLTO (SLOWED).mp3', url: 'https://alisattorov06.github.io/pc/music/ATLXS - PASSO BEM SOLTO (SLOWED).mp3', path: 'online/demo' },
                    { name: 'Rooze', url: 'https://alisattorov06.github.io/pc/music/Rooze.mp3', path: 'online/demo' },
                ];

                const renderPlayer = () => {
                    // Mahalliy + demo qo'shiqlar
                    const localTracks = state.fileSystem.music;
                    const allTracks = [...localTracks, ...demoTracks];
                    const currentTrack = allTracks[currentTrackIndex];

                    el.innerHTML = `
            <div class="flex flex-col h-full">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Music Player</h3>
                <div class="flex gap-2">
                  <button id="scan-music" class="p-2 glass rounded text-sm">Scan Local</button>
                  <button id="demo-music" class="p-2 glass rounded text-sm">Demo Tracks</button>
                </div>
              </div>
              ${allTracks.length > 0 ? `
                <div class="flex-1 flex flex-col items-center justify-center">
                  <div class="text-5xl mb-4">🎵</div>
                  <div class="text-xl font-semibold mb-2 truncate px-4">${currentTrack.name}</div>
                  <div class="text-gray-400 text-sm mb-2">${currentTrack.path}</div>
                  <div class="mt-2 text-sm">${currentTrackIndex + 1} / ${allTracks.length}</div>
                </div>
                <div class="flex justify-center space-x-6 mt-auto pb-4">
                  <button id="prev-btn" class="text-2xl">⏮</button>
                  <button id="play-btn" class="text-3xl">▶</button>
                  <button id="next-btn" class="text-2xl">⏭</button>
                </div>
              ` : `
                <div class="flex-1 flex flex-col items-center justify-center text-center">
                  <div class="text-5xl mb-4">🎵</div>
                  <div class="text-lg mb-2">No tracks found</div>
                  <div class="text-gray-400 text-sm">Click "Scan Local" or "Demo Tracks"</div>
                </div>
              `}
            </div>
          `;

                    if (allTracks.length > 0) {
                        const playBtn = el.querySelector('#play-btn');
                        const prevBtn = el.querySelector('#prev-btn');
                        const nextBtn = el.querySelector('#next-btn');

                        const loadAndPlay = async (trackIndex) => {
                            const track = allTracks[trackIndex];
                            try {
                                // Eski audioni tozalash
                                if (audio) {
                                    audio.pause();
                                    audio.remove();
                                    if (audio.src && audio.src.startsWith('blob:')) {
                                        URL.revokeObjectURL(audio.src);
                                    }
                                }

                                let src;
                                if (track.url) {
                                    // Online qo'shiq
                                    src = track.url;
                                } else {
                                    // Mahalliy fayl
                                    const file = await track.handle.getFile();
                                    src = URL.createObjectURL(file);
                                }

                                audio = new Audio(src);
                                audio.addEventListener('ended', () => {
                                    isPlaying = false;
                                    playBtn.textContent = '▶';
                                    nextTrack();
                                });

                                if (isPlaying) {
                                    await audio.play();
                                    playBtn.textContent = '⏸';
                                }
                            } catch (error) {
                                notify('Error loading track: ' + (error.message || error));
                            }
                        };

                        playBtn.addEventListener('click', async () => {
                            if (!audio) {
                                await loadAndPlay(currentTrackIndex);
                                if (!isPlaying) {
                                    await audio.play();
                                    playBtn.textContent = '⏸';
                                    isPlaying = true;
                                    notify(`Now playing: ${allTracks[currentTrackIndex].name}`);
                                }
                                return;
                            }

                            if (isPlaying) {
                                audio.pause();
                                playBtn.textContent = '▶';
                            } else {
                                await audio.play();
                                playBtn.textContent = '⏸';
                            }
                            isPlaying = !isPlaying;
                        });

                        const nextTrack = () => {
                            currentTrackIndex = (currentTrackIndex + 1) % allTracks.length;
                            isPlaying = true; // Keyingi qo'shiq avtomatik ijro etiladi
                            loadAndPlay(currentTrackIndex).then(() => {
                                playBtn.textContent = '⏸';
                                notify(`Now playing: ${allTracks[currentTrackIndex].name}`);
                            });
                        };

                        const prevTrack = () => {
                            currentTrackIndex = (currentTrackIndex - 1 + allTracks.length) % allTracks.length;
                            isPlaying = true;
                            loadAndPlay(currentTrackIndex).then(() => {
                                playBtn.textContent = '⏸';
                            });
                        };

                        prevBtn.addEventListener('click', prevTrack);
                        nextBtn.addEventListener('click', nextTrack);

                        // Demo tugmasi
                        el.querySelector('#demo-music').addEventListener('click', () => {
                            currentTrackIndex = localTracks.length; // Demo qo'shiqlar boshlanadi
                            isPlaying = false;
                            renderPlayer();
                        });
                    }

                    el.querySelector('#scan-music').addEventListener('click', async () => {
                        await scanForMediaFiles();
                        currentTrackIndex = 0;
                        isPlaying = false;
                        renderPlayer();
                    });
                };

                renderPlayer();

                // 🔒 Ilova yopilganda audio to'xtatish
                if (winId) {
                    const originalClose = AppRegistry.close;
                    AppRegistry.close = function (id) {
                        if (id === winId && audio) {
                            audio.pause();
                            if (audio.src && audio.src.startsWith('blob:')) {
                                URL.revokeObjectURL(audio.src);
                            }
                            audio = null;
                        }
                        return originalClose.call(this, id);
                    };
                }
            }
        });

        AppRegistry.register({
            id: 'gallery',
            name: 'Gallery',
            icon: icons.gallery,
            async render(el) {
                let currentImageIndex = 0;
                let mode = 'demo'; // 'local' yoki 'demo'
                let demoImages = [];

                // Demo rasmlar — tashqi URLlar
                const generateDemoImages = () => {
                    const count = 12;
                    return Array.from({ length: count }, (_, i) => ({
                        name: `Image ${i + 1}`,
                        url: `https://picsum.photos/800/600?random=${i + 1}`,
                        path: 'demo/gallery'
                    }));
                };

                // Avtomatik demoImages yaratish (ilova ochilganda demo-da ochilsin)
                demoImages = generateDemoImages();
                mode = 'demo';
                currentImageIndex = 0;

                const renderGallery = () => {
                    const localImages = state.fileSystem?.images || [];
                    const images = mode === 'demo' ? demoImages : localImages;

                    el.innerHTML = `
        <div class="h-full flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Gallery</h3>
            <div class="flex gap-2">
              <button id="scan-images" class="p-2 glass rounded text-sm">Scan Local</button>
              <button id="demo-gallery" class="p-2 glass rounded text-sm ${mode === 'demo' ? 'neon-text' : ''}">Demo Gallery</button>
            </div>
          </div>
          ${images.length > 0 ? `
            <div class="flex-1 flex items-center justify-center mb-4">
              <img id="current-image" class="max-h-64 max-w-full object-contain rounded-lg" alt="${images[currentImageIndex].name}" />
            </div>
            <div class="flex justify-between items-center">
              <button id="prev-img" class="p-2 glass rounded ${currentImageIndex === 0 ? 'opacity-50' : ''}">⬅</button>
              <div class="text-sm">${currentImageIndex + 1} / ${images.length}</div>
              <button id="next-img" class="p-2 glass rounded ${currentImageIndex === images.length - 1 ? 'opacity-50' : ''}">➡</button>
            </div>
            <div class="mt-2 text-center text-xs text-gray-400 truncate">${images[currentImageIndex].name}</div>
          ` : `
            <div class="flex-1 flex flex-col items-center justify-center text-center">
              <div class="text-5xl mb-4">🖼️</div>
              <div class="text-lg mb-2">${mode === 'demo' ? 'Loading demo...' : 'No images found'}</div>
              <div class="text-gray-400 text-sm">
                ${mode === 'demo'
                            ? 'Fetching images from Picsum...'
                            : 'Use "scan" command or click Scan Local'}
              </div>
            </div>
          `}
        </div>
      `;

                    // Agar rasmlar mavjud bo'lsa, src ni o'rnatish
                    if (images.length > 0) {
                        const currentImage = el.querySelector('#current-image');
                        const src = mode === 'demo'
                            ? images[currentImageIndex].url
                            : URL.createObjectURL(images[currentImageIndex].handle);

                        currentImage.src = src;

                        // Mahalliy fayl bo'lsa onload dan keyin revoke qilish
                        if (mode !== 'demo') {
                            currentImage.onload = () => URL.revokeObjectURL(src);
                        }

                        // Prev/Next tugmalari
                        const prevBtn = el.querySelector('#prev-img');
                        const nextBtn = el.querySelector('#next-img');

                        if (prevBtn) {
                            prevBtn.onclick = () => {
                                if (currentImageIndex > 0) {
                                    currentImageIndex--;
                                    renderGallery();
                                }
                            };
                        }
                        if (nextBtn) {
                            nextBtn.onclick = () => {
                                if (currentImageIndex < images.length - 1) {
                                    currentImageIndex++;
                                    renderGallery();
                                }
                            };
                        }
                    }

                    // Tugmalar - Scan va Demo (har doim mavjud)
                    const scanBtn = el.querySelector('#scan-images');
                    const demoBtn = el.querySelector('#online-gallery');

                    if (scanBtn) {
                        scanBtn.onclick = async () => {
                            mode = 'local';
                            currentImageIndex = 0;
                            await scanForMediaFiles(); // mavjud scan funksiyani chaqirasiz deb hisoblayman
                            renderGallery();
                        };
                    }

                    if (demoBtn) {
                        demoBtn.onclick = () => {
                            mode = 'demo';
                            currentImageIndex = 0;
                            demoImages = generateDemoImages();
                            renderGallery();
                        };
                    }
                };

                // Birinchi render — demoImages bilan avtomatik ko'rsatadi
                renderGallery();
            }
        });


        AppRegistry.register({
            id: 'files',
            name: 'Files',
            icon: icons.files,
            render(el, data = {}) {
                const history = data.history || ['root'];
                const current = history[history.length - 1];

                function renderFolder(folder) {
                    const files = state.fileSystem[folder] || [];
                    el.innerHTML = `
            <div class="h-full flex flex-col">
              <div class="flex items-center mb-3">
                ${history.length > 1 ? `<button class="back-btn p-1 rounded glass mr-2">⬅</button>` : ''}
                <span class="font-medium">${folder === 'root' ? 'Files' : folder}</span>
              </div>
              <div class="space-y-2 flex-1 overflow-y-auto">
                ${folder === 'root' ? `
                  <div class="p-3 glass rounded cursor-pointer folder-item" data-folder="music">
                    📁 music (${state.fileSystem.music.length} files)
                  </div>
                  <div class="p-3 glass rounded cursor-pointer folder-item" data-folder="images">
                    📁 images (${state.fileSystem.images.length} files)
                  </div>
                ` : files.map(file => `
                  <div class="p-3 pl-8 glass rounded flex justify-between items-center">
                    <span>${file.name}</span>
                    <span class="text-xs text-gray-400">${file.path}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;

                    if (history.length > 1) {
                        el.querySelector('.back-btn').addEventListener('click', () => {
                            history.pop();
                            renderFolder(history[history.length - 1]);
                        });
                    }

                    if (folder === 'root') {
                        el.querySelectorAll('.folder-item').forEach(item => {
                            item.addEventListener('click', () => {
                                const newFolder = item.dataset.folder;
                                history.push(newFolder);
                                renderFolder(newFolder);
                            });
                        });
                    }
                }

                renderFolder(current);
            }
        });

        AppRegistry.register({
            id: 'settings',
            name: 'Settings',
            icon: icons.settings,
            render(el) {
                el.innerHTML = `
          <div class="space-y-4 h-full flex flex-col">
            <h3 class="text-lg font-semibold neon-text">System Settings</h3>
            <div class="flex-1">
              <label class="flex items-center">
                <input type="checkbox" id="anim-toggle" ${state.settings.animations ? 'checked' : ''} class="mr-2">
                Enable Animations
              </label>
            </div>
            <button id="scan-media" class="w-full p-3 glass rounded">Scan Media Files</button>
            <button id="reset-btn" class="w-full p-3 glass rounded text-red-300">Reset Layout</button>
          </div>
        `;

                el.querySelector('#anim-toggle').addEventListener('change', (e) => {
                    state.settings.animations = e.target.checked;
                    AppRegistry.saveState();
                });

                el.querySelector('#scan-media').addEventListener('click', async () => {
                    await scanForMediaFiles();
                    notify('Media files scanned successfully');
                });

                el.querySelector('#reset-btn').addEventListener('click', () => {
                    if (confirm('Reset all windows?')) {
                        state.windows.forEach(w => AppRegistry.close(w.id));
                        AppRegistry.saveState();
                    }
                });
            }
        });

        AppRegistry.register({
            id: 'notes',
            name: 'Notes',
            icon: icons.notes,
            render(el) {
                const noteKey = 'hyperOSNotes';
                let content = localStorage.getItem(noteKey) || '';
                el.innerHTML = `<textarea id="notes-editor" class="w-full h-full bg-black/20 rounded-lg p-3 outline-none resize-none">${content}</textarea>`;
                const editor = el.querySelector('#notes-editor');
                let saveTimer;
                editor.addEventListener('input', () => {
                    clearTimeout(saveTimer);
                    saveTimer = setTimeout(() => {
                        localStorage.setItem(noteKey, editor.value);
                    }, 500);
                });
            }
        });

        AppRegistry.register({
            id: 'youtube',
            name: 'YouTube',
            icon: icons.youtube,
            render(el) {
                const videos = [
                    { title: "Video 1", id: "pPhgj8cYf-M" },
                    { title: "Video 2", id: "94XBcesxLWo" },
                    { title: "Video 3", id: "9bZkp7q19f0" },
                    { title: "Video 4", id: "3JZ_D3ELwOQ" }
                ];

                el.innerHTML = `
      <div class="h-full w-full overflow-auto p-2 flex flex-col gap-4">
        ${videos.map(v => `
          <div class="flex flex-col gap-2">
            <div class="text-sm font-semibold text-gray-700">${v.title}</div>
            <iframe 
              src="https://www.youtube.com/embed/${v.id}" 
              class="w-full aspect-video rounded-lg"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
              allowfullscreen>
            </iframe>
          </div>
        `).join('')}
      </div>
    `;
            }
        });


        AppRegistry.register({
            id: 'tetris',
            name: 'Tetris',
            icon: icons.tetris,
            render(el) {
                // O'lchamni qat'iy belgilash
                const container = document.createElement('div');
                container.style.width = '300px';
                container.style.height = '600px';
                container.style.overflow = 'hidden';
                el.appendChild(container);
                initTetris(container);
            }
        });

        // === INIT ===
        function initIcons(containerId, vertical = true) {
            const container = document.getElementById(containerId);
            const appIds = ['terminal', 'calculator', 'music', 'gallery', 'files', 'notes', 'youtube', 'tetris', 'settings'];
            appIds.forEach(id => {
                const app = state.apps[id];
                const icon = document.createElement('div');
                icon.className = vertical ? 'desktop-icon' : 'app-icon';
                icon.innerHTML = `${app.icon}<span>${app.name}</span>`;
                icon.addEventListener('dblclick', () => AppRegistry.open(id));
                container.appendChild(icon);
            });
        }

        function initDock() {
            const dock = document.getElementById('dock');
            const appIds = ['terminal', 'calculator', 'music', 'gallery', 'files', 'notes', 'youtube', 'tetris', 'settings'];
            appIds.forEach(id => {
                const app = state.apps[id];
                const btn = document.createElement('div');
                btn.className = 'app-icon';
                btn.innerHTML = app.icon;
                btn.addEventListener('click', () => AppRegistry.open(id));
                dock.appendChild(btn);
            });
        }

        function updateClock() {
            document.getElementById('system-clock').textContent = formatTime(new Date());
        }

        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            AppRegistry.loadState();
            initIcons('desktop-icons', true);
            initDock();
            updateClock();
            updateBattery();
            updateWeather();
            setInterval(updateClock, 1000);

            if (state.windows.length === 0) {
                setTimeout(() => AppRegistry.open('terminal'), 500);
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Neon / suyuq shisha overlay
            const overlay = document.createElement("div");
            overlay.id = "win11-lock-overlay";
            Object.assign(overlay.style, {
                position: "fixed",
                top: 0,
                left: 0,
                width: "100%",
                height: "100%",
                background: "rgba(0,0,0,0.85)", // ozgina shaffof qora
                backdropFilter: "blur(12 px) saturate(180%)",
                WebkitBackdropFilter: "blur(12px) saturate(180%)",
                display: "flex",
                flexDirection: "column",
                alignItems: "center",
                justifyContent: "center",
                fontFamily: "'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                color: "#00fff7",
                textShadow: "0 0 12px #00fff7, 0 0 24px #00f0ff77, 0 0 48px #0ff",
                fontSize: "2.5rem",
                fontWeight: "300",
                zIndex: 99999,
                textAlign: "center",
                padding: "0 20px",
                boxSizing: "border-box"
            });

            // Soat elementi
            const timeElement = document.createElement("div");
            timeElement.id = "lock-screen-time";
            Object.assign(timeElement.style, {
                fontSize: "5rem",
                fontWeight: "200",
                letterSpacing: "4px",
                marginBottom: "60px",
                textShadow: "0 0 8px #00fff7, 0 0 16px #00f0ff77"
            });

            // GO tugmasi
            const btn = document.createElement("button");
            btn.innerText = "GO";
            Object.assign(btn.style, {
                padding: "14px 50px",
                borderRadius: "12px",
                background: "rgba(0,255,255,0.08)",
                border: "1px solid rgba(0,255,255,0.4)",
                color: "#00fff7",
                cursor: "pointer",
                fontSize: "1.2rem",
                fontWeight: "600",
                backdropFilter: "blur(18px) saturate(200%)",
                WebkitBackdropFilter: "blur(18px) saturate(200%)",
                boxShadow: "0 0 20px #00fff7aa, 0 0 40px #00f0ff55 inset",
                transition: "0.2s all",
                textShadow: "0 0 6px #00fff7"
            });

            btn.onmouseenter = () => {
                btn.style.boxShadow = "0 0 30px #00fff7cc, 0 0 60px #00f0ff88 inset";
                btn.style.transform = "scale(1.05)";
            };
            btn.onmouseleave = () => {
                btn.style.boxShadow = "0 0 20px #00fff7aa, 0 0 40px #00f0ff55 inset";
                btn.style.transform = "scale(1)";
            };
            btn.onmousedown = () => {
                btn.style.transform = "scale(0.97)";
            };
            btn.onmouseup = () => {
                btn.style.transform = "scale(1)";
            };

            // Soatni yangilash funksiyasi
            const updateTime = () => {
                const now = new Date();
                let hours = now.getHours().toString().padStart(2, '0');
                let minutes = now.getMinutes().toString().padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}`;
            };

            updateTime();
            setInterval(updateTime, 60000);

            // Overlayga soat va tugma qo'shish
            overlay.appendChild(timeElement);
            overlay.appendChild(btn);
            document.body.appendChild(overlay);

            // GO tugmasi bosilganda
            btn.addEventListener("click", async () => {
                try {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) await elem.requestFullscreen();
                    else if (elem.webkitRequestFullscreen) await elem.webkitRequestFullscreen();
                    else if (elem.msRequestFullscreen) await elem.msRequestFullscreen();

                    overlay.remove();
                } catch (err) {
                    console.error("Fullscreen ruxsati berilmadi:", err);
                }
            });
        });
    </script>



</body>

</html>